name: Return the release notes extracted from the body of the PR associated with the release.

#
# Returns the release notes from the content of a pull request linked to a release branch. It expects the branch name to be in the format release/vX.Y.Z, release/X.Y.Z, release/vX.Y.Z-beta.N. etc.
#
# TODO: Remove once the common repo is public.
#
inputs:
  version:
    required: true
  repo_name:
    required: false
  repo_owner:
    required: true
  token:
    required: true

outputs:
  release-notes:
    value: ${{ steps.get_release_notes.outputs.RELEASE_NOTES }}

runs:
  using: composite

  steps:
    - uses: actions/github-script@v7
      id: get_release_notes
      with:
        result-encoding: string
        script: |
          console.log(`Searching for PR with head: ${process.env.REPO_OWNER}:release/${process.env.VERSION}`);
          
          const { data: pulls } = await github.rest.pulls.list({
            owner: process.env.REPO_OWNER,
            repo: process.env.REPO_NAME,
            state: 'all',
            head: `${process.env.REPO_OWNER}:release/${process.env.VERSION}`,
          });
          
          console.log(`Found ${pulls.length} PRs matching the criteria`);
          
          if (pulls.length === 0) {
            console.log('No PR found for this release branch. Using default release notes.');
            const defaultNotes = `## ðŸš€ Release ${process.env.VERSION}
          
          This release includes updates and improvements.
          
          ### ðŸ“¦ Installation
          \`\`\`bash
          npm install @auth0/${process.env.VERSION.split('-')[0]}
          \`\`\``;
            core.setOutput('RELEASE_NOTES', defaultNotes);
          } else {
            const releaseNotes = pulls[0].body || 'No release notes provided in the PR.';
            console.log('Using release notes from PR body');
            core.setOutput('RELEASE_NOTES', releaseNotes);
          }
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
        REPO_OWNER: ${{ inputs.repo_owner }}
        REPO_NAME: ${{ inputs.repo_name }}
        VERSION: ${{ inputs.version }}